<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>scPECA GRNDB | Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">ðŸ§¬ scPECA GRNDB</div>
      <div class="spacer"></div>
      <nav><a href="index.html">Home</a><a href="search.html">Search</a><a href="software.html">Software</a><a href="contact.html">Contact</a></nav>
    </div>
  </header>

  <main class="container">
    <div id="errbar" class="errbar"></div>
    <section class="filters" aria-label="Filters">
      <div class="field">
        <label for="species">Species</label>
        <select id="species">
          <option value="human">Human</option>
          <option value="mouse">Mouse</option>
        </select>
      </div>
      <div class="field">
        <label for="source">Source</label>
        <select id="source">
          <option value="paired">paired bulk RNA&amp;ATAC</option>
          <option value="unpaired">unpaired scRNA&amp;scATAC</option>
          <option value="multiome">sc-multiome</option>
        </select>
      </div>
      <div class="field">
        <label for="tissue">organ/tissue/cell type</label>
        <select id="tissue"><option value="">All</option></select>
      </div>
      <div class="actions">
        <a class="btn btn-primary disabled" id="btn-download" target="_blank" rel="noopener" aria-disabled="true">Download GRN</a>
        <a class="btn btn-secondary disabled" id="btn-source" target="_blank" rel="noopener" aria-disabled="true">Source Data</a>
        <button class="btn btn-secondary" id="apply">Apply</button>
      </div>
    </section>

    <section class="panel two-col" id="details" style="display:none">
      <div class="section">
        <header><h3 style="margin:0">Summary</h3></header>
        <div class="meta" id="meta"></div>
        <div class="desc" id="summary"></div>
      </div>
      <div class="section" id="ct-section">
        <header>
          <h3 style="margin:0">organ/tissue/cell type</h3>
          <span id="totals" class="chip mono"></span>
        </header>
        <div class="ct-list">
          <table>
            <thead><tr><th style="width:60%">Name</th><th class="mono">RNA cells</th><th class="mono">ATAC cells</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <div id="empty" class="empty">Choose filters above and click <b>Apply</b> to view dataset details.</div>
  </main>

  <footer>Â© <span id="year"></span> scPECA GRNDB. CC BY 4.0.</footer>

  <script>
    let DATASETS = [];

    async function load(){
      const err = document.getElementById('errbar');
      const ver = Date.now();
      try{
        const url = new URL('catalog.json', window.location.href); url.searchParams.set('v', ver);
        const res = await fetch(url.toString(), {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        DATASETS = json.datasets || [];
        hydrate();
      }catch(e){
        if(err){ err.style.display='block'; err.textContent = 'Failed to load catalog.json â€” ' + e; }
      }
    }

    function hydrate(){
      const tissues = Array.from(new Set(DATASETS.map(d=>d.tissue))).sort();
      const sel = document.getElementById('tissue');
      sel.innerHTML = '<option value="">All</option>' + tissues.map(t=>`<option value="${t}">${t}</option>`).join('');
    }

    function cap(s){return s? s.charAt(0).toUpperCase()+s.slice(1):''}
    function labelSource(k){ return ({
      paired:'paired bulk RNA&ATAC',
      unpaired:'unpaired scRNA&scATAC',
      multiome:'sc-multiome'
    })[k] || k }
    function chip(t){ const s=document.createElement('span'); s.className='chip'; s.textContent=t; return s }
    function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;","\u003e":"&gt;"}[m]||m))}

    function pass(d, S){
      if (S.species && d.species!==S.species) return false;
      if (S.source  && d.source_type!==S.source) return false;
      if (S.tissue  && d.tissue!==S.tissue) return false;
      return true;
    }

    function render(){
      const S = {
        species: document.getElementById('species').value,
        source:  document.getElementById('source').value,
        tissue:  document.getElementById('tissue').value
      };
      const arr = DATASETS.filter(d=>pass(d,S));
      const empty = document.getElementById('empty');
      const details  = document.getElementById('details');
      const ctSection = document.getElementById('ct-section');

      // Reset buttons
      const dl = document.getElementById('btn-download');
      const sd = document.getElementById('btn-source');
      dl.classList.add('disabled'); sd.classList.add('disabled');
      dl.setAttribute('aria-disabled','true'); sd.setAttribute('aria-disabled','true');

      if (!arr.length){
        empty.style.display = 'block';
        details.style.display = 'none';
        fillDetails(null, S);
        return;
      }
      const d = arr[0];
      empty.style.display = 'none';
      details.style.display = 'grid';

      // If source == paired, hide right column (organ/tissue/cell type)
      ctSection.style.display = (S.source === 'paired') ? 'none' : 'block';

      // Enable buttons
      dl.href = d.figshare_url; sd.href = d.source_data_url;
      dl.classList.remove('disabled'); sd.classList.remove('disabled');
      dl.removeAttribute('aria-disabled'); sd.removeAttribute('aria-disabled');

      fillDetails(d, S);
    }

    function fillDetails(d, S){
      const meta = document.getElementById('meta'); const summary = document.getElementById('summary');
      const tb   = document.getElementById('tbody'); const totals = document.getElementById('totals');
      meta.innerHTML=''; summary.textContent=''; tb.innerHTML=''; totals.textContent='';

      if (!d) return;

      [cap(d.species), labelSource(d.source_type), d.tissue, (d.modalities||[]).join(' + '), d.version, 'Updated ' + d.updated]
        .filter(Boolean).forEach(t=> meta.append(chip(t)));

      summary.textContent = d.summary_text || d.description || '';

      if (S.source === 'paired') return; // stop here for paired bulk

      let totalRNA = 0, totalATAC = 0;
      (d.cell_types||[]).forEach(x => {
        totalRNA += +x.rna_cells || 0; totalATAC += +x.atac_cells || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(x.name)}</td><td class="mono">${(+x.rna_cells||0).toLocaleString()}</td><td class="mono">${(+x.atac_cells||0).toLocaleString()}</td>`;
        tb.appendChild(tr);
      });
      totals.textContent = `Total RNA: ${totalRNA.toLocaleString()} | ATAC: ${totalATAC.toLocaleString()}`;
    }

    document.getElementById('apply').onclick = render;
    document.getElementById('year').textContent = new Date().getFullYear();
    load();
  </script>
</body>
</html>
